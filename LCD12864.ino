#include <dht11.h>  //get tempeature
#include <DS1302.h>  //get accurate time
#include <Arduino.h>
#include <U8g2lib.h>
#include <EEPROM.h>

#ifdef U8X8_HAVE_HW_SPI
#include <SPI.h>
#endif
#ifdef U8X8_HAVE_HW_I2C
#include <Wire.h>
#endif

unsigned long fps = 0;
const int BuzzerPin = 2;
const int TemPin =  3;
const int RS = 4;
const int WR = 5;
const int EN = 6;
const int RST = 7;
const int DAT = 8;
const int CLOCK = 9;
const int CLK = 10;
const int ConfPin = 11;
const int DT = 12;

unsigned long LastTime;
boolean isAlarm;
boolean currentStateCLK;
boolean lastStateCLK;
const int ClockWidth = 96;
const int ClockHeight = 32;
const int menuItems = 4;
byte hour, minute;

dht11 DHT11;
U8G2_ST7920_128X64_F_SW_SPI u8g2(U8G2_R0, EN, WR, RS, U8X8_PIN_NONE);
DS1302 rtc(RST, DAT, CLOCK);

const char *myMenus[] = {"Back", "Set Time", "Set Alarm", "Alarm On/Off"};
const char *myDays[] =  {"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"};
static const unsigned char Ring[] U8X8_PROGMEM = {
  0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x7E, 0x18, 0x00
};  //the ring icon
static const unsigned char UpArrow[] U8X8_PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0xC0, 0x03, 0xE0, 0x07, 0x80, 0x01, 0x80, 0x01,
  0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00
};  //the uparrow icon
static const unsigned char AlarmClock[] U8X8_PROGMEM = {
  0xF0, 0x01, 0x80, 0x0F, 0x1C, 0x07, 0xE0, 0x38, 0x06, 0x0C, 0x30, 0x60, 0x02, 0x0C, 0x30, 0x40,
  0x03, 0x07, 0xE0, 0xC0, 0xC1, 0xF9, 0x9F, 0x83, 0x71, 0x8E, 0x71, 0x8E, 0x1B, 0x83, 0xC1, 0xD8,
  0xC6, 0x00, 0x00, 0x63, 0x40, 0x00, 0x00, 0x06, 0x20, 0x00, 0x40, 0x04, 0x30, 0x00, 0x60, 0x0C,
  0x10, 0x00, 0x30, 0x08, 0x18, 0x00, 0x18, 0x18, 0x08, 0x00, 0x0C, 0x10, 0x08, 0x00, 0x04, 0x10,
  0x08, 0x00, 0x06, 0x10, 0x38, 0x00, 0x03, 0x1C, 0xB8, 0xFF, 0x01, 0x1C, 0x08, 0x00, 0x00, 0x10,
  0x08, 0x00, 0x00, 0x10, 0x18, 0x00, 0x00, 0x10, 0x10, 0x00, 0x00, 0x18, 0x10, 0x00, 0x00, 0x08,
  0x20, 0x00, 0x00, 0x04, 0x60, 0x00, 0x00, 0x06, 0xC0, 0x00, 0x00, 0x03, 0x80, 0x81, 0x81, 0x01,
  0x00, 0x86, 0x61, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x80, 0x01, 0x80, 0x01, 0xC0, 0x00, 0x00, 0x03,
};  //the bell icon
static const unsigned char ARDUINO_LOGO_128X64[] U8X8_PROGMEM = {
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x00, 0xFE, 0xFF, 0xFF, 0x3F, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x00, 0xF0, 0xFF, 0xFF, 0x03, 0x00, 0xF0, 0x7F, 0xFE, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0x00, 0x00, 0xC0, 0x7F, 0xFE, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0x00, 0xFF, 0x3F, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0x00, 0xFE, 0x1F, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x0F, 0x80, 0x7F, 0x00, 0xF8, 0x07, 0x00, 0x7F, 0x00, 0xFC, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x07, 0xF0, 0xFF, 0x03, 0xF0, 0x03, 0xF0, 0xFF, 0x03, 0xF8, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x03, 0xF8, 0xFF, 0x0F, 0xE0, 0x01, 0xF8, 0xFF, 0x07, 0xF0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x03, 0xFE, 0xFF, 0x1F, 0xC0, 0x00, 0xFE, 0xFF, 0x1F, 0xE0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x01, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0xFF, 0xFF, 0x3F, 0xE0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x81, 0xFF, 0xFF, 0xFF, 0x00, 0x80, 0xFF, 0xFF, 0x7F, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x80, 0xFF, 0xFF, 0xFF, 0x01, 0xC0, 0xFF, 0xF1, 0x7F, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x80, 0xFF, 0xFF, 0xFF, 0x03, 0xE0, 0xFF, 0xF1, 0xFF, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xFF, 0x03, 0xF0, 0xFF, 0xF1, 0xFF, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xC0, 0x3F, 0x00, 0xFE, 0x07, 0xF8, 0x1F, 0x00, 0xFF, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xC0, 0x3F, 0x00, 0xFE, 0x07, 0xF8, 0x1F, 0x00, 0xFF, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xC0, 0x3F, 0x00, 0xFE, 0x07, 0xF0, 0x1F, 0x00, 0xFF, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xFF, 0x03, 0xF0, 0xFF, 0xF1, 0xFF, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x80, 0xFF, 0xFF, 0xFF, 0x01, 0xE0, 0xFF, 0xF1, 0x7F, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x80, 0xFF, 0xFF, 0xFF, 0x00, 0xC0, 0xFF, 0xF1, 0x7F, 0xC0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x01, 0xFF, 0xFF, 0x7F, 0x00, 0x80, 0xFF, 0xFF, 0x3F, 0xE0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x01, 0xFE, 0xFF, 0x3F, 0xC0, 0x00, 0xFE, 0xFF, 0x1F, 0xE0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x03, 0xFC, 0xFF, 0x0F, 0xE0, 0x01, 0xFC, 0xFF, 0x0F, 0xF0, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x07, 0xF0, 0xFF, 0x03, 0xF0, 0x03, 0xF0, 0xFF, 0x03, 0xF8, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x0F, 0xC0, 0xFF, 0x00, 0xF8, 0x07, 0xC0, 0xFF, 0x00, 0xF8, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0x00, 0xFC, 0x1F, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0x00, 0xFF, 0x3F, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0xE0, 0xFF, 0xFF, 0x01, 0x00, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0xFC, 0xFF, 0xFF, 0x0F, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xBF, 0x3F, 0xF8, 0xC1, 0xE7, 0x3B, 0xC0, 0xF9, 0x3E, 0xFC, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x1F, 0x1F, 0xE0, 0x00, 0xC7, 0x39, 0xC0, 0x71, 0x1E, 0xF8, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x0F, 0x1E, 0xE7, 0x18, 0xC7, 0xF9, 0xF9, 0x61, 0x8E, 0xF1, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x4F, 0x1E, 0xE7, 0x38, 0xC6, 0xF9, 0xF9, 0x61, 0xCE, 0xF3, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x47, 0x1E, 0xE3, 0x38, 0xC6, 0xF9, 0xF9, 0x49, 0xCE, 0xF3, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x67, 0x1C, 0xF0, 0x38, 0xC6, 0xF9, 0xF9, 0x19, 0xCE, 0xF3, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x07, 0x1C, 0xF1, 0x38, 0xC7, 0xF9, 0xF9, 0x19, 0xCE, 0xF3, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xE3, 0x18, 0xE3, 0x08, 0xC7, 0xF8, 0xF9, 0x39, 0x8E, 0xF1, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xF3, 0x19, 0xC7, 0x80, 0x0F, 0x3C, 0xC0, 0x79, 0x1E, 0xF8, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
};

void setup() {
  pinMode(CLK, INPUT_PULLUP);
  pinMode(ConfPin, INPUT_PULLUP);
  pinMode(DT, INPUT_PULLUP);
  noTone(BuzzerPin);
  LastTime = millis();
  isAlarm = (boolean)EEPROM.read(0);
  hour = EEPROM.read(1);
  minute = EEPROM.read(2);
  u8g2.begin();
  BOOTING_UP();
}

void loop() {
  boolean isPressed = digitalRead(ConfPin);
  if (!isPressed && millis() - LastTime > 300) {
    LastTime = millis();
    SelectMenu();
  }
  else
    PrintWin();
}

void BOOTING_UP() {
  u8g2.firstPage();
  do {
    u8g2.drawXBMP(0, 0, 128, 64, ARDUINO_LOGO_128X64);
  } while ( u8g2.nextPage() );
  delay(1000);
}

//draw the emulated clock hands
void DrawHand(float time, float steps, int radius)
{
  double angle = time * 2.0 * 3.1415 / steps - 1;
  double X = ClockWidth + radius * cos(angle);
  double Y = ClockHeight + radius * sin(angle);
  u8g2.drawLine(ClockWidth, ClockHeight, X, Y);
}

//print main UI
void PrintWin() {
  u8g2.firstPage();
  do {
    //print date
    Time time = rtc.time();
    DHT11.read(TemPin);
    u8g2.setColorIndex(1);
    u8g2.drawRFrame(0, 0, 128, 64, 4);
    u8g2.drawRFrame(68, 4, 57, 57, 3);
    if (isAlarm)u8g2.drawXBMP( 58, 26, 8, 8, Ring);
    if (isAlarm == true && time.hr == hour && time.min == minute) {
      u8g2.drawXBMP( 18, 30, 32, 32, AlarmClock);
      tone(BuzzerPin, 300);
      if (!digitalRead(ConfPin)) {
        isAlarm = !isAlarm;
        noTone(BuzzerPin);
        LastTime = millis();
      }
    }
    else {
      u8g2.setFont(u8g2_font_5x8_tr);
      u8g2.setCursor(7, 55);
      u8g2.print(time.yr);
      u8g2.drawStr( 29, 55, "/");
      u8g2.setCursor(36, 55);
      u8g2.print(time.mon);
      u8g2.drawStr( 43, 55, "/");
      u8g2.setCursor(51, 55);
      u8g2.print(time.date);
      u8g2.setFont(u8g2_font_6x13_tr);
      u8g2.setCursor(10, 41);
      u8g2.print(myDays[time.day - 1]);
      u8g2.setCursor(33, 41);
      u8g2.print(DHT11.temperature);
      u8g2.drawCircle(47, 34, 1, U8G2_DRAW_ALL);
      u8g2.setCursor(50, 41);
      u8g2.print('C');
    }

    //print time
    u8g2.drawRBox(3, 4, 62, 21, 2);
    u8g2.setColorIndex(0);
    u8g2.setFont(u8g2_font_ncenB14_tf);
    u8g2.drawStr(32, 19, ":");
    int position;
    if (time.hr < 10)
    {
      u8g2.drawStr(6, 21, "0");
      position = 19;
    }
    else position = 6;
    u8g2.setCursor(position, 21);
    u8g2.print(time.hr);
    if (time.min < 10)
    {
      u8g2.drawStr(41, 21, "0");
      position = 54;
    }
    else position = 41;
    u8g2.setCursor(position , 21);
    u8g2.print(time.min);
    u8g2.setColorIndex(1);

    //print emulated clock
    u8g2.drawCircle(ClockWidth, ClockHeight, 26);
    u8g2.drawCircle(ClockWidth, ClockHeight, 1);
    u8g2.setFont(u8g2_font_6x13_tr);
    u8g2.drawStr(90, 17, "12");
    u8g2.drawStr(114, 37, "3");
    u8g2.drawStr(94, 56, "6");
    u8g2.drawStr(72, 37, "9");
    DrawHand(time.hr - 1, 12.0, 10);
    DrawHand(time.min - 5, 60.0, 19);
    DrawHand(time.sec - 5, 60, 21);
  } while ( u8g2.nextPage() );
}

void SelectMenu() {
  int count = 0;
  PrintMenu(count);
  while (1) {
    boolean isPressed = digitalRead(ConfPin);
    if (!isPressed && millis() - LastTime > 300) {
      LastTime = millis();
      switch (count) {
        case 0: ; break;
        case 1: SET_TIME(); break;
        case 2: SET_CLOCK(); break;
        case 3: ALARM_ON_OFF(); break;
      }
      break;
    }
    else {
      currentStateCLK = digitalRead(CLK);
      if (currentStateCLK != lastStateCLK  && currentStateCLK == LOW) {
        if (digitalRead(DT) != currentStateCLK) {
          if (count > 0)
            count--;
        }
        else if (count < 3)
          count++;
        PrintMenu(count);
      }
      lastStateCLK = currentStateCLK;
    }
  }
}

void PrintMenu(int count) {
  u8g2.firstPage();
  do {
    u8g2.setFont(u8g2_font_6x13_tr);
    u8g2.drawRFrame(0, 0, 128, 64, 4);
    u8g2.drawRBox(8, 3 + 14 * count, u8g2.getStrWidth(myMenus[count]) + 4, 15, 2);
    u8g2.setColorIndex(0);
    u8g2.drawStr(10, 15 + 14 * count, myMenus[count]);
    u8g2.setColorIndex(1);
    for (int i = 0; i < menuItems; i++) {
      if (i != count)
        u8g2.drawStr(10, 15 + 14 * i, myMenus[i]);
    }
  }
  while ( u8g2.nextPage() );
}

void ALARM_ON_OFF() {
  isAlarm = !isAlarm;
  EEPROM.write(0, isAlarm);
  u8g2.firstPage();
  do {
    u8g2.setFont(u8g2_font_6x13_tr);
    u8g2.drawRFrame(0, 0, 128, 64, 4);
    if (isAlarm) {
      u8g2.drawRBox(27, 22, u8g2.getStrWidth("Alarm ON!") + 6, 17, 2);
      u8g2.setColorIndex(0);
      u8g2.drawStr(30, 35, "Alarm ON!");
      u8g2.setColorIndex(1);
    }
    else {
      u8g2.drawRBox(27, 22, u8g2.getStrWidth("Alarm OFF!") + 6, 17, 2);
      u8g2.setColorIndex(0);
      u8g2.drawStr(30, 35, "Alarm OFF!");
      u8g2.setColorIndex(1);
    }
  } while ( u8g2.nextPage() );
  delay(1000);
}

//set clock
void SET_CLOCK() {
  LastTime = millis();
  int hour1 = hour / 10, hour2 = hour % 10, minute1 = minute / 10, minute2 = minute % 10;
  int timeArrey[] = {hour1, hour2, minute1, minute2};
  int position = 0;
  boolean isChoice = true;
  PRINT_SET_CLOCK(timeArrey, position, isChoice);
  while (1) {
    boolean isPressed = digitalRead(ConfPin);
    if (!isPressed && millis() - LastTime > 300) {
      position ++;
      PRINT_SET_CLOCK(timeArrey, position, isChoice);
      LastTime = millis();
      if (position == 5) {
        byte hou = timeArrey[0] * 10 + timeArrey[1];
        byte minu = timeArrey[2] * 10 + timeArrey[3];
        if (hou < 24 && minu < 60 && isChoice) {
          isAlarm = true;
          hour = hou;
          minute = minu;
          EEPROM.write(0, isAlarm);//write data to EEPROM
          EEPROM.write(1, hour);
          EEPROM.write(2, minute);
          u8g2.firstPage();
          do {
            u8g2.setFont(u8g2_font_6x13_tr);
            u8g2.drawRFrame(0, 0, 128, 64, 4);
            u8g2.drawRBox(35, 22, u8g2.getStrWidth("Finished!") + 6, 17, 2);
            u8g2.setColorIndex(0);
            u8g2.drawStr(38, 35, "Finished!");
            u8g2.setColorIndex(1);
          } while ( u8g2.nextPage() );
        }
        else {
          u8g2.firstPage();
          do {
            u8g2.setFont(u8g2_font_6x13_tr);
            u8g2.drawRFrame(0, 0, 128, 64, 4);
            u8g2.drawRBox(35, 22, u8g2.getStrWidth("Cancled!") + 6, 17, 2);
            u8g2.setColorIndex(0);
            u8g2.drawStr(38, 35, "Cancled!");
            u8g2.setColorIndex(1);
          } while ( u8g2.nextPage() );
        }
        delay(1000);
        break;
      }
    }
    else {
      currentStateCLK = digitalRead(CLK);
      if (currentStateCLK != lastStateCLK  && currentStateCLK == LOW) {
        if (digitalRead(DT) != currentStateCLK) {
          if (position < 4) {
            if (position == 0 && timeArrey[position] < 2)
              timeArrey[position]++;
            else if (position == 1 && timeArrey[position] < 9)
              timeArrey[position]++;
            else if (position == 2 && timeArrey[position] < 6)
              timeArrey[position]++;
            else if (position == 3 && timeArrey[position] < 9)
              timeArrey[position]++;
          }
          else {
            isChoice = !isChoice;
          }
        }
        else {
          if (position < 4) {
            if (timeArrey[position] > 0)
              timeArrey[position]--;
          }
          else {
            isChoice = !isChoice;
          }
        }
        PRINT_SET_CLOCK(timeArrey, position, isChoice);
      }
      lastStateCLK = currentStateCLK;
    }
  }
}

//print setting clock UI
void PRINT_SET_CLOCK(int timeArrey[], int position, boolean isChoice) {
  u8g2.firstPage();
  do {
    u8g2.setFont(u8g2_font_ncenB14_tf);
    u8g2.drawRFrame(0, 0, 128, 64, 4);
    u8g2.setCursor(28 + 16 * 2 , 24);
    u8g2.print(':');
    for (int i = 0; i < 4; i++) {
      if (i < 2)
        u8g2.setCursor(28 + 16 * i, 28);
      else
        u8g2.setCursor(23 + 16 * (i + 1), 28);
      u8g2.print(timeArrey[i]);
    }
    if (position < 4) {
      u8g2.setFont(u8g2_font_5x8_tr);
      u8g2.drawStr(45, 59, "Confirm");
      u8g2.drawStr(90, 59, "Cancle");
    }
    else if (position == 4 && isChoice) {
      u8g2.setFont(u8g2_font_5x8_tr);
      u8g2.drawRBox(43, 51, u8g2.getStrWidth("Confirm") + 4, 10, 2);
      u8g2.setColorIndex(0);
      u8g2.drawStr(45, 59, "Confirm");
      u8g2.setColorIndex(1);
      u8g2.drawStr(90, 59, "Cancle");
    }
    else if (position == 4 && !isChoice) {
      u8g2.setFont(u8g2_font_5x8_tr);
      u8g2.drawRBox(88, 51, u8g2.getStrWidth("Cancle") + 4, 10, 2);
      u8g2.setColorIndex(0);
      u8g2.drawStr(90, 59, "Cancle");
      u8g2.setColorIndex(1);
      u8g2.drawStr(45, 59, "Confirm");
    }
    if (position < 2)
      u8g2.drawXBMP( 25 + 16 * position, 30, 16, 16, UpArrow);
    else if (position < 4)
      u8g2.drawXBMP( 20 + 16 * (position + 1), 30, 16, 16, UpArrow);
  } while ( u8g2.nextPage() );
}

//set clock
void SET_TIME() {
  Time ti = rtc.time();
  int hour1 = ti.hr / 10, hour2 = ti.hr % 10, minute1 = ti.min / 10, minute2 = ti.min % 10;
  int timeArrey[] = {hour1, hour2, minute1, minute2};
  int position = 0;
  boolean isChoice = true;
  PRINT_SET_TIME(timeArrey, position, isChoice);
  LastTime = millis();
  while (1) {
    boolean isPressed = digitalRead(ConfPin);
    if (!isPressed && millis() - LastTime > 300) {
      position ++;
      PRINT_SET_CLOCK(timeArrey, position, isChoice);
      LastTime = millis();
      if (position == 5) {
        byte hou = timeArrey[0] * 10 + timeArrey[1];
        byte minu = timeArrey[2] * 10 + timeArrey[3];
        if (hou < 24 && minu < 60 && isChoice) {
          Time time = rtc.time();
          rtc.writeProtect(false);
          rtc.halt(false);
          Time t(time.yr, time.mon, time.date, hou, minu, 0, time.day);
          rtc.time(t);
          rtc.writeProtect(true);
          rtc.halt(true);
          u8g2.firstPage();
          do {
            u8g2.setFont(u8g2_font_6x13_tr);
            u8g2.drawRFrame(0, 0, 128, 64, 4);
            u8g2.drawRBox(35, 22, u8g2.getStrWidth("Finished!") + 6, 17, 2);
            u8g2.setColorIndex(0);
            u8g2.drawStr(38, 35, "Finished!");
            u8g2.setColorIndex(1);
          } while ( u8g2.nextPage() );
        }
        else {
          u8g2.firstPage();
          do {
            u8g2.setFont(u8g2_font_6x13_tr);
            u8g2.drawRFrame(0, 0, 128, 64, 4);
            u8g2.drawRBox(35, 22, u8g2.getStrWidth("Cancled!") + 6, 17, 2);
            u8g2.setColorIndex(0);
            u8g2.drawStr(38, 35, "Cancled!");
            u8g2.setColorIndex(1);
          } while ( u8g2.nextPage() );
        }
        delay(1000);
        break;
      }
    }
    else {
      currentStateCLK = digitalRead(CLK);
      if (currentStateCLK != lastStateCLK  && currentStateCLK == LOW) {
        if (digitalRead(DT) != currentStateCLK) {
          if (position < 4) {
            if (position == 0 && timeArrey[position] < 2)
              timeArrey[position]++;
            else if (position == 1 && timeArrey[position] < 9)
              timeArrey[position]++;
            else if (position == 2 && timeArrey[position] < 6)
              timeArrey[position]++;
            else if (position == 3 && timeArrey[position] < 9)
              timeArrey[position]++;
          }
          else {
            isChoice = !isChoice;
          }
        }
        else {
          if (position < 4) {
            if (timeArrey[position] > 0)
              timeArrey[position]--;
          }
          else {
            isChoice = !isChoice;
          }
        }
        PRINT_SET_TIME(timeArrey, position, isChoice);
      }
      lastStateCLK = currentStateCLK;
    }
  }
}

//print setting clock UI
void PRINT_SET_TIME(int timeArrey[], int position, boolean isChoice) {
  u8g2.firstPage();
  do {
    u8g2.setFont(u8g2_font_ncenB14_tf);
    u8g2.drawRFrame(0, 0, 128, 64, 4);
    u8g2.setCursor(28 + 16 * 2 , 24);
    u8g2.print(':');
    for (int i = 0; i < 4; i++) {
      if (i < 2)
        u8g2.setCursor(28 + 16 * i, 28);
      else
        u8g2.setCursor(23 + 16 * (i + 1), 28);
      u8g2.print(timeArrey[i]);
    }
    if (position < 4) {
      u8g2.setFont(u8g2_font_5x8_tr);
      u8g2.drawStr(45, 59, "Confirm");
      u8g2.drawStr(90, 59, "Cancle");
    }
    else if (position == 4 && isChoice) {
      u8g2.setFont(u8g2_font_5x8_tr);
      u8g2.drawRBox(43, 51, u8g2.getStrWidth("Confirm") + 4, 10, 2);
      u8g2.setColorIndex(0);
      u8g2.drawStr(45, 59, "Confirm");
      u8g2.setColorIndex(1);
      u8g2.drawStr(90, 59, "Cancle");
    }
    else if (position == 4 && !isChoice) {
      u8g2.setFont(u8g2_font_5x8_tr);
      u8g2.drawRBox(88, 51, u8g2.getStrWidth("Cancle") + 4, 10, 2);
      u8g2.setColorIndex(0);
      u8g2.drawStr(90, 59, "Cancle");
      u8g2.setColorIndex(1);
      u8g2.drawStr(45, 59, "Confirm");
    }
    if (position < 2)
      u8g2.drawXBMP( 25 + 16 * position, 30, 16, 16, UpArrow);
    else if (position < 4)
      u8g2.drawXBMP( 20 + 16 * (position + 1), 30, 16, 16, UpArrow);
  } while ( u8g2.nextPage() );
}
